<!DOCTYPE html>
<html lang="ja">
<style>

table {
    border-collapse: collapse;
    text-align: center;
}
th,
td {
    padding: 5px;
    border: 1px solid #333;    
}
th {
    background-color: #2c88d9;
    color: #fff;
}
</style>

<head>
    <meta charset="utf-8">
    　<title>html ファイルIO入門 </title>

</head>
<body>
    <div>test</div>


    <input type="file" id="files" name="files[]" multiple />
    <output id="list"></output>
    <div id="download"></div>
    <div id="res"></div>
    <script>
        let files;
        let reader = new FileReader();
        const parser = new window.DOMParser();
           
      function handleFileSelect(evt) {
        files = evt.target.files; // FileList object
    
        // files is a FileList of File objects. List some properties.
        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                      f.size, ' bytes, last modified: ',
                      f.lastModified.toPrecision(), '</li>');
                      reader.onload = function(ev){
                         //テキストエリアに表示する
                        var readText = reader.result;
                        addTable(readText,document.getElementById('res'));
                        console.debug("made table")


                    }        
                    reader.readAsText(f);
                }
                document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

      }

      document.getElementById('files').addEventListener('change', handleFileSelect, false);
      </script>        
</body>

<script>
function addDownloadLink(readText)
{
    const blb = new Blob([readText],{type:"text/plain"})
    document.getElementById('download').innerHTML = 
                        "<a id=\"downloadFile\">"+"text"+"</a>";     
    var link= document.getElementById("downloadFile");                    
    link.href= URL.createObjectURL(blb);                    
    link.download = 'download.csv';

}

function addTable(readText,tab2){
    var arr = parser.parseFromString( readText , "text/xml").getElementsByTagName("book");
    tab2.innerHTML += "<table id=\"table1\"></table>";
    console.debug(tab2.innerHTML)
    let table1 = document.getElementById("table1");
    table1.innerHTML += 
    "<tr>"+
        "<th>year</th>"+
        "<th>auth</th>"+
        "<th>title</th>"+
    "</tr>"
    var output = "";
    for(i=0;i<arr.length ; i++)
    {
        element = arr[i]
        title = element.getElementsByTagName("title")[0].innerHTML
        year = element.getElementsByTagName("title")[0].getAttribute("year")
        author = element.getElementsByTagName("author")[0].innerHTML


        table1.innerHTML +=
            "<tr>" +
                "<td>"+year+"</td>"+
                "<td>"+author+"</td>"+
                "<td>"+title+"</td>"+
            "</tr>";
            output += `${year},${title},${author}\n`
        }
        addDownloadLink(output)
}
</script>