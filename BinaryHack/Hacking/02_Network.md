# Networkについて

```text
OSI参照モデル--------------|
|     アプリケーション層    | <- HTTP通信はここ
|  　 プレゼンテーション層 　|
|       セッション層       | <- Cとかで扱うソケットはこの層
|------------------------|
|     トランスポート層      | <- TCP/UDP通信はここ,トランスポートプロトコルを提供
|                        |
|------------------------|
|       　     　 　　　　 | <- IP(IPプロトコル)はここ、パケットレベルの通信を扱う
|       ネットワーク層     |    ICMP(Pingとかで使うプロトコル)はこの層を使う
|                        |    パケットサイズに制限がある場合のパケット分割機能も提供している。
|                        |    コネクションの維持、パケットの確実な配送の確立はトランスポート層が担う。
|------------------------|
|      データリンク層　     | <-イーサネットのプロトコルがこの階層にあたる。
|                        |    この辺でMACアドレスとかを管理してる。
|                        |    arpはここと、ネットワーク層を使ってIPから
|                        |    MACアドレスを割り当ててIPに対応したMACアドレス宛に通信を行う
| -----------------------|    
|          物理層         |
|                        |
|------------------------|

```

---

## TCPとUDPの差異について

- TCPはTCPヘッダを用いることで、データのやりとりを同期し、シーケンス番号でデータ並びを揃え、不足分の再送などをするため、通信時のオーバーヘッドが発生するものの、信頼できる双方向通信を実現できる。

- UDPはTCPに比べ機能が少ないもののオーバーヘッドが小さくなる。コネクションの確立、信頼性も高くないため動作としてIPプロトコル(ネットワーク層)の動作に近い。
  - UDPヘッダは、RFC 768にて、発信元ポート、宛先ポート、長さ、チェックサムの16バイトと規定されている。

## ソケットについて

- ソケットにはストリームソケットとデータグラムソケットがある。
  - ストリームソケット
    - 誰かと電話するときのような、双方向通信をするものトランスポート層のTCPプロトコルを使用する。

  - データグラムソケット
    - 手紙のように一方通行で、送った順序で届くとは限らない上に、全く届かないこともある。
    - パケットの喪失があっても許容できる場合に使われる。(ネットゲーム、ストリーミングメディアなど)

## ARP(Address Resolution Protocol)とは

- IPアドレスとハードウェアの対応付をするプロトコル。
  - 機器毎のMACアドレスとネットワーク層で定期的に変わる可能性のあるIPアドレスとで対応付ることができるっぽい
  - ARPメッセージには4つのタイプがある。
    - 基本「ARPリクエストメッセージ」「ARPリプライメッセージ」の2つが最も重要なタイプとなる。
  - 通信の流れの一例を挙げる。
    - 同じネットワーク内にMACアドレス1のIP1を持つ機器1とMACアドレス2,IP2を持つ機器2があり、機器1から機器2に対して通信を行うとする。
      1. ARPを用いて機器1からIP2を指定してブロードキャストで「ARPリクエスト」を送る。(送信元のMACアドレスも送られる。)
      2. IP2を持つ機器2が送信元MACアドレス(機器1)に対して自身のMACアドレスを送信する。
      3. 以降の通信はARPキャッシュに保存されるため、ARPのやりとりをせずに直でMACアドレスを指定して通信を行う。

## ネットワークのスニッフィング

`『スニッフィング(snifing)』` :  他の機器宛てに送られるパケットをキャプチャする行為。

- スイッチングネットワークと非スイッチングネットワークのデータリンク層には、違いがある。
  - 「非スイッチングネットワーク」では、イーサネットのパケットはネットワーク上の全ての機器に送られる。そのため、各機器が自ら判断して上位のレイヤーに引き渡すようになっている。

  - これをネットワーク機器の設定で`『プロミスキャストモード』`にすることで、パケットの宛先に関係なく全てのパケットを読み込むことができるようになる。
    - tcpdumpのような、ほとんどのパケットキャプチャプログラムは、デフォルトでネットワーク機器をプロミスキャストモードに変更するようになっている。
    以下のコマンドで変更を行うことができる。
    > sudo ifconfig eth0 promisc

- やり方
  - こんな感じtcpdumpだけでなく、dsniffというツールだと、重要と判断したデータを解析して表示してくれる。

```sh
tcpdump -l -X 'ip host 172.17.0.2'
dsniff -n
```

- 🚨あくまでtcpのパケットだけで、UDP,ICMPのプロトコルは見れてない

## 生のソケットのスニッフィング

生のソケットに関する問題は`libpcap`を使うことで緩和できたりする。
BSDやSolarisなどプラットフォームでの問題も緩和してくれる。
